#!/bin/sh
# preinst script for libvirt-daemon-system
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    install|upgrade)
	# When renaming the .service file, systemd might become confused, we
	# need to ensure that the libvirtd daemon is fully stopped before
	# trying to restart it again. (Bug: #730604)
	if dpkg --compare-versions "$2" lt "1.2.6-1~"; then
	    if [ -d /run/systemd/system ]; then
	        [ ! -f /lib/systemd/system/libvirt-bin.service ] || invoke-rc.d libvirt-bin stop
	    fi
	    # Remove everything we know about libvirt-bin.service
	    deb-systemd-helper purge libvirt-bin.service >/dev/null
	    deb-systemd-helper unmask libvirt-bin.service >/dev/null
	fi
    ;;

    abort-upgrade)
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
